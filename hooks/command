#!/bin/bash
set -euo pipefail

echo "~~~ :package: JSON Watcher"

# Configuration
URLS="${BUILDKITE_PLUGIN_JSON_WATCHER_URLS:-}"
FIELD="${BUILDKITE_PLUGIN_JSON_WATCHER_FIELD:-}"
EXPECTED_VALUE="${BUILDKITE_PLUGIN_JSON_WATCHER_EXPECTED_VALUE:-}"
# default to 60s from plugin.yml
POLLING_INTERVAL="${BUILDKITE_PLUGIN_JSON_WATCHER_POLLING_INTERVAL:-60}"

# Validate
if [[ -z "$URLS" ]]; then
  echo "Error: 'urls' parameter is required"
  exit 1
fi

if [[ -z "$FIELD" ]]; then
  echo "Error: 'field' parameter is required"
  exit 1
fi

if [[ -z "$EXPECTED_VALUE" ]]; then
  echo "Error: 'expected_value' parameter is required"
  exit 1
fi

# Parse comma-separated URLs into array
IFS=',' read -ra URLS_ARRAY <<< "$URLS"

echo "Monitoring ${#URLS_ARRAY[@]} URL(s)"
echo "Field: ${FIELD}"
echo "Expected value: ${EXPECTED_VALUE}"
echo "Polling every ${POLLING_INTERVAL}s"
echo ""

# Fetch and extract field value
fetch_field_value() {
  local url="$1"
  local response
  local http_code
  local body
  local value

  response=$(curl -sSL -w "\n%{http_code}" "${url}" 2>&1) || { echo "ERROR"; return; }

  http_code=$(echo "$response" | tail -n1)
  body=$(echo "$response" | sed '$d')

  if [[ "$http_code" == "200" ]]; then
    value=$(echo "$body" | jq -r "${FIELD}" 2>/dev/null || echo "ERROR")
    # Strip -SNAPSHOT suffix if present
    value="${value%-SNAPSHOT}"
    echo "$value"
  else
    echo "HTTP_${http_code}"
  fi
}

# Status display
show_status() {
  local url="$1"
  local value="$2"
  local target="$3"

  if [[ "$value" == "ERROR" ]]; then
    echo "  ❌ ${url}: Connection error"
  elif [[ "$value" =~ ^HTTP_ ]]; then
    local code="${value##HTTP_}"
    echo "  ❌ ${url}: HTTP status ${code}"
  elif [[ "$value" == "$target" ]]; then
    echo "  ✓ ${url}: ${value} (matches!)"
  elif [[ "$value" == "null" ]]; then
    echo "  ❌ ${url}: Field not found in JSON"
  else
    echo "  ${url}: found ${value} (expected value: ${target})"
  fi
}

while true; do
  all_matched=true

  for url in "${URLS[@]}"; do
    # Trim whitespace
    url=$(echo "$url" | xargs)

    value=$(fetch_field_value "$url")
    show_status "$url" "$value" "$EXPECTED_VALUE"

    if [[ "$value" != "$EXPECTED_VALUE" ]]; then
      all_matched=false
    fi
  done

  if [[ "$all_matched" == "true" ]]; then
    echo ""
    echo "✓ Success! All URLs have ${FIELD}=${EXPECTED_VALUE}"
    exit 0
  fi

  echo ""
  sleep "$POLLING_INTERVAL"
done
